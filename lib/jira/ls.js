var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDefaultCreate=exports.lsCommand=void 0;const t=e(require("cli-table")),s=e(require("../config")),r=e(require("chalk")),i=e(require("async")),l=e(require("alasql")),o=e(require("../ssl_request")),n=require("../helpers/helpers"),u=e(require("inquirer"));exports.lsCommand=(e,s)=>{e.command("ls").description("List my issues").option("-p, --project <name>","Filter by project",String).option("-t, --type <type>","Filter by type",String).option("-v, --verbose","verbose output").action((async e=>{let i,l;try{l=await async function(e){return await n.client.issueSearch.searchForIssuesUsingJqlGet({jql:"assignee=currentUser()",fields:["*all"],maxResults:500})}(),function(e,s){const i=new t.default({head:["Key","Priority","Summary","Status","FixVersions"],chars:{top:"","top-mid":"","top-left":"","top-right":"",bottom:"","bottom-mid":"","bottom-left":"","bottom-right":"",left:"","left-mid":"",mid:"","mid-mid":"",right:"","right-mid":""},style:{"padding-left":1,"padding-right":1,head:["cyan"],compact:!1}}),l=[];[...new Set(e.map((e=>e.fields.parent?.key)))].forEach((t=>{if(!t)return;l.push(e.find((e=>e.key===t)));const s=e.filter((e=>e.fields.parent?.key===t)).sort().reverse();l.push(...s),e=e.filter((e=>e.fields?.parent?.key!==t&&e.key!==t))})),l.push(...e),e=l.filter((e=>"Done"!==e.fields.status.name));for(let t=0;t<e.length;t+=1){let s=e[t].fields?.priority;const l=e[t].fields.summary,o=e[t].fields.status;s||(s={name:""});const n=e[t].fields.fixVersions?.map((e=>e.name)).join(",");"Epic"===e[t].fields?.issuetype?.name?i.push([r.default.redBright(e[t]?.key),s.name,l,o.name,n??"n/a"]):e[t].fields?.parent?i.push(["|-"+e[t].key,s.name,l,o.name,n??"n/a"]):i.push([e[t].key,s.name,l,o.name,n??"n/a"])}e.length>0?s&&s.no_print||console.log(i.toString()):console.log("No issues")}(l.issues)}catch(e){i=e}finally{s(i,l)}}))};exports.getDefaultCreate=async e=>{const t=s.default.default_create.__always_ask.fields;if(!t)return;const r=[];for(const e in t){const t=await u.default.prompt({name:e,message:`what is ${e}`,type:"input",default:null});t[e]&&r.push(t)}return r},exports.default={project:null,query:null,type:null,issues:null,table:null,callIssueApi(e,t){const r=[];let l=0,n=0;i.default.doWhilst((t=>{l=0;const i=`${s.default.auth.url}${this.query}&startAt=${n}&maxResults=500`;e&&e.verbose&&console.log(i),o.default.get(i).then((e=>e.ok?(r.push(...r,...e.body.issues),l=e.body.issues.length,n+=l,t(null,r)):t((e.body.errorMessages||[e.error]).join("\n")))).catch((e=>t((e.body.errorMessages||[e.error]).join("\n"))))}),((e,t)=>t(null,0!==l)),(e=>{t(e,r)}))},getIssues:function(e,s){s||(s=e,e=null),this.callIssueApi(e,((i,l)=>{if(i)return s(i);if(e&&e.json)return s(null,l);this.issues=l,this.table=new t.default({head:["Key","Priority","Summary","Status","FixVersions"],chars:{top:"","top-mid":"","top-left":"","top-right":"",bottom:"","bottom-mid":"","bottom-left":"","bottom-right":"",left:"","left-mid":"",mid:"","mid-mid":"",right:"","right-mid":""},style:{"padding-left":1,"padding-right":1,head:["cyan"],compact:!0}});for(let e=0;e<this.issues.length;e+=1){let t=this.issues[e].fields.priority,s=this.issues[e].fields.summary;const i=this.issues[e].fields.status;if(t||(t={name:""}),s.length>50&&(s=s.substr(0,47)+"..."),this.issues[e].fields.fixVersions.length){const l=this.issues[e].fields.fixVersions.map((e=>e.name)).join(",");this.table.push([r.default.redBright(this.issues[e].key),t.name,s,i.name,l])}else this.table.push([r.default.redBright(this.issues[e].key),t.name,s,i.name,"n/a"])}return this.issues.length>0?e&&e.no_print||console.log(this.table.toString()):console.log("No issues"),s(null,this.issues)}))},showAll(e,t){return this.type=e&&e.type?'+AND+type="'+e.type+'"':"",this.query="rest/api/2/search?jql=assignee=currentUser()"+this.type+'+AND+status+in+("'+this.getAvailableStatuses()+'")+order+by+key+DESC&maxResults=500',this.getIssues(e,t)},showInProgress:function(e){return this.query='rest/api/2/search?jql=assignee=currentUser()+AND+status+in+("In+Progress")+order+by+priority+DESC,+key+ASC',this.getIssues(e)},showByProject:function(e,t){this.type=e&&e.type?"+AND+type="+e.type:"";const s=e&&e.project?"+AND+project="+e.project:"";return this.query="rest/api/2/search?jql=assignee=currentUser()"+this.type+s+'+AND+status+in+("'+this.getAvailableStatuses()+'")+order+by+priority+DESC,+key+ASC',this.getIssues(t)},search:function(e,t){return this.query='rest/api/2/search?jql=summary+~+"'+e+'"+OR+details+~+"'+e+'"+OR+comment+~+"'+e+'"+order+by+priority+DESC,+key+ASC',this.getIssues(t)},jqlSearch:function(e,t,r){let i;return i=t&&t.custom?s.default.custom_jql&&s.default.custom_jql[t.custom]?s.default.custom_jql[t.custom]:t.custom:s.default.custom_jql&&s.default.custom_jql[e]?s.default.custom_jql[e]:e,this.query="rest/api/2/search?jql="+encodeURIComponent(i),this.getIssues(t,r)},getAvailableStatuses:function(){return s.default.options.available_issues_statuses.join('", "')},aggregateResults:function(e,r,i){r||(r={}),r.json=!0,this.jqlSearch(e,r,(function(e,o){if(e)return i(e);let n;if(!r||!r.custom_sql)return i(new Error("no custom sql found"));n=s.default.custom_alasql&&s.default.custom_alasql[r.custom_sql]?s.default.custom_alasql[r.custom_sql]:r.custom_sql;let u=[];try{console.log(n),u=l.default(n,[o])}catch(e){return i(e)}if(!u.length)return i(new Error("No Result"));const a=new t.default({head:Object.keys(u[0])});let c=[];for(let e=0;e<u.length;e+=1)c=[],Object.keys(u[0]).forEach((function(t){c.push(u[e][t]||"")})),a.push(c);return console.log(a.toString()),i(null,u)}))}};