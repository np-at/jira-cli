var t=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.registerTransitionCommand=void 0;const i=t(require("../ssl_request")),o=t(require("cli-table")),n=t(require("../config")),e=t(require("inquirer-autocomplete-prompt")),s=t(require("inquirer")).default.createPromptModule().registerPrompt("autocomplete",e.default);exports.registerTransitionCommand=t=>{t.command("t [issue] [transition_state]")},exports.default={query:null,transitions:null,transitionID:null,ask(t,i,o,n,e){const a=[];let r=0;if(e||!1===e)return i(e);if(n&&n.length>0){for(;r<n.length;r++)this.isSubTask?void 0!==n[r].subtask?n[r].subtask&&a.push("("+n[r].id+") "+(n[r].name?n[r].name:n[r].value)):a.push("("+n[r].id+") "+(n[r].name?n[r].name:n[r].value)):n[r].subtask||a.push("("+n[r].id+") "+(n[r].name?n[r].name:n[r].value));console.log(a.join("\n"))}const u=n.map((function(t){return t.id}));s({message:t}).then((e=>{e.length>0?u.indexOf(e)>=0?i(e):this.ask(t,i,o,n):o?i(!1):this.ask(t,i)}))},doTransition:function(t,o,e,s){"function"==typeof e&&(s=e,e=null),this.query="rest/api/2/issue/"+t+"/transitions";const a={transition:{id:o}};e&&n.default.options.jira_done.check_resolution&&(a.fields={resolution:{id:e}}),i.default.post(n.default.auth.url+this.query).send(a).end(((t,i)=>{i.ok||s((i.body.errorMessages||[i.error]).join("\n")),s&&s()}))},getTransitions:function(t,o){this.query="rest/api/2/issue/"+t+"/transitions",i.default.get(n.default.auth.url+this.query).end(((t,i)=>{if(!i.ok)return o(new Error(i.body.errorMessages.join("\n")));const n=i.body.transitions||[];return o(null,n)}))},makeTransition:function(t,i){this.getTransitions(t,((o,n)=>{if(o)return i(o);this.ask("Enter transition ",(o=>{this.doTransition(t,o,(t=>t?i(t):(console.log("marked issue with transition "+o),i())))}),null,n)}))},getTransitionCode:function(t,i,n){this.getTransitions(t,((t,e)=>{if(t)return n(t);if(e.some((t=>{(t.name===i||t.to.name===i)&&(this.transitionID=t.id)})),this.transitionID)n(this.transitionID);else if(console.log("Issue already "+i+" or bad transition."),e){console.log("Available Transitions");const t=new o.default({head:["Key","Name"]});e.forEach((function(i){t.push([i.id,i.name])})),console.log(t.toString())}}))},getResolutionCode:function(t,e){this.query="rest/api/2/resolution",i.default.get(n.default.auth.url+this.query).end(((i,n)=>{if(!n.ok)return console.log(n.body.errorMessages.join("\n"));const s=n.body;let a;if(t&&""!==t?s.forEach((function(i){i.name===t&&(a=i)})):!t&&s.length>0&&(a=s[0]),a)return e(a.id);{console.log("Resolution Not Found!\n"),console.log("Available Resolutions");const t=new o.default({head:["Key","Name","Description"]});return s.forEach((function(i){t.push([i.id,i.name,i.description])})),console.log(t.toString()),void console.log("You can change this behaviour by editing ~/.jira/config.json")}}))},start:function(t,i){this.transitionName=n.default.options.jira_start.status,this.getTransitionCode(t,this.transitionName,(o=>{this.doTransition(t,o,(o=>{console.log("Issue ["+t+"] moved to "+this.transitionName),i(o)}))}))},stop:function(t,i){this.transitionName=n.default.options.jira_stop.status,this.getTransitionCode(t,this.transitionName,(o=>{this.doTransition(t,o,(o=>{console.log("Issue ["+t+"] moved to "+this.transitionName),i(o)}))}))},review:function(t,i){this.transitionName=n.default.options.jira_review.status,this.getTransitionCode(t,this.transitionName,(o=>{this.doTransition(t,o,(o=>{console.log("Issue ["+t+"] moved to "+this.transitionName),i(o)}))}))},done:function(t,i,o){this.transitionName=n.default.options.jira_done.status,this.resolutionName=i,this.getResolutionCode(this.resolutionName,(i=>{this.getTransitionCode(t,this.transitionName,(n=>{this.doTransition(t,n,i,(i=>{console.log("Issue ["+t+"] moved to "+this.transitionName),o(i)}))}))}))},invalid:function(t,i,o){this.transitionName=n.default.options.jira_invalid.status,this.resolutionName=i,this.getResolutionCode(this.resolutionName,(i=>{this.getTransitionCode(t,this.transitionName,(n=>{this.doTransition(t,n,i,(i=>{console.log("Issue ["+t+"] moved to "+this.transitionName),o(i)}))}))}))}};