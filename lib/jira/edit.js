var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const t=e(require("../ssl_request")),r=e(require("../config")),a=require("../common"),u=e(require("inquirer")).default.createPromptModule();exports.default=(()=>{const e={ask:function(t,r,a,s,o){const n=[];let l,i=0;if(o||!1===o)return r(o);if(s&&s.length>0){for(;i<s.length;i++)this.isSubTask?void 0!==s[i].subtask?s[i].subtask&&n.push("("+s[i].id+") "+(s[i].name?s[i].name:s[i].value)):n.push("("+s[i].id+") "+(s[i].name?s[i].name:s[i].value)):s[i].subtask||n.push("("+s[i].id+") "+(s[i].name?s[i].name:s[i].value));console.log(n.join("\n"))}u({message:t}).then((u=>{if(u.length>0){if(s&&s.forEach((function(e){e.id!==u&&e.value!==u&&e.name!==u||(u=e.value,l=!0)})),!s)return r(u);if(l)return r(u);e.ask(t,r,a,s)}else a?r(!1):e.ask(t,r)}))},getMeta(e,a){this.query="rest/api/2/issue/"+e+"/editmeta",t.default.get(r.default.auth.url+this.query).end(((e,t)=>{if(!t.ok)return console.log((t.body.errorMessages||[t.error]).join("\n")),a((t.body.errorMessages||[t.error]).join("\n"));a(null,t.body.fields)}))},getOutputFormat(e,t,r,a,u,s){s||(s=function(e,t){if(e)throw e;return t});const o=e[r];if(!o||!o.schema)return s(new Error("wrong meta"));let n;return u.fields||(u.fields={}),"string"===o.schema.type?n=a.toString():"array"===o.schema.type?"string"===o.schema.items&&(n=a.toString().split(",")):"any"===o.schema.type?console.log("not yet supported"):"priority"===o.schema.type&&(n={id:a}),n?(u.fields[r]=n,s(null,u)):s(new Error("this type of field is not supported yet"))},makeEditCall(e,a,u){this.query="rest/api/2/issue/"+e,t.default.put(r.default.auth.url+this.query).send(a).end(((e,t)=>t.ok?(console.log("Issue edited successfully!"),u()):(console.log(t),t.body&&t.body.errorMessages?(console.log(t.body&&t.body.errorMessages&&t.body.errorMessages.join("\n")),u(t.body.errorMessages.join("\n"))):u(new Error("some error")))))},editWithInputPutBody(t,a,u){e.getMeta(t,(function(s,o){if(s)return u(s);let n={};if(r.default&&r.default.edit_meta&&r.default.edit_meta.__default&&r.default.edit_meta.__default[a])n=r.default.edit_meta.__default[a];else{const r=e.parseEditInput(a);Object.keys(r).forEach((function(a){n=e.getOutputFormat(o,t,a,r[a],n)}))}e.makeEditCall(t,n,u)}))},parseEditInput(e){const t=e.toString().split(";;");let a,u,s,o,n;const l={};return t.forEach((function(e){a=e.split("::"),u=a[0],s=a[1],r.default&&r.default.edit_meta&&r.default.edit_meta[u]?(r.default.edit_meta[u].key&&(o=r.default.edit_meta[u].key),r.default.edit_meta[u].default&&r.default.edit_meta[u].default[s]&&(n=r.default.edit_meta[u].default[s])):(o=u,n=s),l[o]=n})),l},edit(t,r){e.getMeta(t,(function(u,s){if(u)return r(u);const o=[];Object.keys(s).forEach((function(e,t){o.push({id:t,value:e,name:s[e].name})})),e.ask("enter Input ",(u=>{let o;console.log(u),s[u]&&s[u].allowedValues&&s[u].allowedValues.length&&(o=s[u].allowedValues),a.ask("Enter value ",(function(a){e.getOutputFormat(s,t,u,a,{},(function(a,u){if(a)return r(a);e.makeEditCall(t,u,r)}))}),null,o)}),null,o)}))}};return e})();